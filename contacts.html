<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>良王庄乡机关干部通讯录</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f0f2f5;
            color: #333;
        }
        
        /* 登录界面样式 */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 100%;
            max-width: 400px;
            margin: 20px;
        }
        
        .login-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }
        
        .password-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
        }
        
        .error-msg {
            color: #d32f2f;
            margin-top: 15px;
            font-size: 0.9em;
            display: none;
        }
        
        /* 主要内容样式 */
        .main-content {
            display: none;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* 新增按钮样式 */
        .add-contact-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .add-contact-btn:hover {
            background: rgba(76, 175, 80, 1);
        }

        .data-manage-btn {
            position: absolute;
            top: 20px;
            left: 160px;
            padding: 10px 20px;
            background: rgba(255, 193, 7, 0.9);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .data-manage-btn:hover {
            background: rgba(255, 193, 7, 1);
        }
        
        .emergency-section {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .emergency-section h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .emergency-contacts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .emergency-card {
            background: #ffebee;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
        }
        
        .emergency-card .title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .emergency-card .phone {
            color: #d32f2f;
            font-size: 1.2em;
        }
        
        .search-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .search-controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-item .label {
            color: #666;
        }
        
        .stat-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .contacts-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .contact-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
        }
        
        .contact-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }
        
        .contact-card .name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .contact-card .department {
            color: #667eea;
            font-size: 0.95em;
            margin-bottom: 12px;
        }
        
        .contact-card .info-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            color: #555;
            font-size: 0.95em;
        }
        
        .contact-card .info-item .icon {
            margin-right: 8px;
            width: 16px;
        }

        /* 操作按钮样式 */
        .contact-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .btn-edit, .btn-delete {
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #4CAF50;
            color: white;
        }

        .btn-edit:hover {
            background: #45a049;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #da190b;
        }
        
        .no-results {
            text-align: center;
            padding: 60px;
            color: #999;
            font-size: 1.1em;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #333;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-primary, .btn-secondary {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e9e9e9;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* 成功消息样式 */
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .logout-btn, .add-contact-btn, .data-manage-btn {
                position: static;
                margin: 10px 5px;
                width: calc(33.33% - 10px);
                left: auto;
            }
            
            .search-controls {
                grid-template-columns: 1fr;
            }
            
            .contact-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }

            .modal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h2 class="login-title">🔐 系统验证</h2>
            <p class="login-subtitle">良王庄乡机关干部通讯录<br>请输入访问密码</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="请输入密码" maxlength="10">
            <button onclick="checkPassword()" class="login-btn">验证登录</button>
            <div id="errorMsg" class="error-msg">❌ 密码错误，请重新输入</div>
        </div>
    </div>

    <!-- 主要内容 -->
    <div id="mainContent" class="main-content">
        <div class="container">
            <div class="header">
                <button onclick="showAddModal()" class="add-contact-btn">+ 新增联系人</button>
                <button onclick="showDataManagement()" class="data-manage-btn">📊 数据管理</button>
                <button onclick="logout()" class="logout-btn">退出登录</button>
                <h1>良王庄乡机关干部通讯录</h1>
                <p>内部使用 · 请妥善保管</p>
            </div>
            
            <div id="successMessage" class="success-message"></div>
            
            <div class="emergency-section">
                <h3>🚨 紧急联系电话</h3>
                <div class="emergency-contacts">
                    <div class="emergency-card">
                        <div class="title">区政府办</div>
                        <div class="phone">📞 63032789</div>
                    </div>
                    <div class="emergency-card">
                        <div class="title">区委办公室</div>
                        <div class="phone">📞 63032888</div>
                    </div>
                    <div class="emergency-card">
                        <div class="title">区应急办</div>
                        <div class="phone">📞 68692821</div>
                    </div>
                </div>
            </div>
            
            <div class="search-section">
                <div class="search-controls">
                    <input type="text" id="searchInput" placeholder="搜索姓名、部门或电话号码..." onkeyup="filterContacts()">
                    <select id="departmentFilter" onchange="filterContacts()">
                        <option value="">所有部门</option>
                    </select>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <span class="label">总人数：</span>
                        <span class="value" id="totalCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">筛选结果：</span>
                        <span class="value" id="filteredCount">0</span>
                    </div>
                </div>
            </div>
            
            <div class="contacts-section">
                <div class="contact-grid" id="contactGrid">
                    <!-- 联系人卡片将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑联系人模态框 -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">新增联系人</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="contactForm">
                <div class="form-group">
                    <label for="contactName">姓名 *</label>
                    <input type="text" id="contactName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="contactDepartment">部门 *</label>
                    <select id="contactDepartment" name="department" required>
                        <option value="">请选择部门</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contactMobile">手机号码</label>
                    <input type="tel" id="contactMobile" name="mobile" pattern="[0-9]{11}">
                </div>
                <div class="form-group">
                    <label for="contactOfficePhone">办公电话</label>
                    <input type="tel" id="contactOfficePhone" name="officePhone">
                </div>
                <div class="form-group">
                    <label for="contactHomePhone">家庭电话</label>
                    <input type="tel" id="contactHomePhone" name="homePhone">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">取消</button>
                    <button type="submit" class="btn-primary" id="submitBtn">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 数据管理模态框 -->
    <div id="dataManagementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">数据管理</h3>
                <button class="close-btn" onclick="closeDataManagement()">&times;</button>
            </div>
            <div style="margin: 20px 0;">
                <div class="form-group">
                    <label>当前状态</label>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                        <div>📊 总联系人数：<strong id="dataManageCount">0</strong></div>
                        <div>💾 数据已自动保存到浏览器本地存储</div>
                        <div>⏰ 最后更新：<span id="lastUpdateTime">未知</span></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>数据操作</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn-secondary" onclick="exportData()">📥 导出数据</button>
                        <button type="button" class="btn-secondary btn-danger" onclick="clearLocalStorage()">🗑️ 清除本地数据</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>说明</label>
                    <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                        • 所有修改会自动保存到浏览器本地存储<br>
                        • 数据仅在当前浏览器中有效<br>
                        • 建议定期导出数据进行备份<br>
                        • 清除浏览器数据会丢失所有修改
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-primary" onclick="closeDataManagement()">关闭</button>
            </div>
        </div>
    </div>
    
    <script>
        // 密码验证功能
        const correctPassword = '159357';
        
        // 本地存储键名
        const STORAGE_KEY = 'lwz_contacts_data';
        const VERSION_KEY = 'lwz_data_version';
        const CURRENT_VERSION = '1.0';
        
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            
            if (password === correctPassword) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('errorMsg').style.display = 'none';
                initializeContacts();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        function logout() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('errorMsg').style.display = 'none';
        }
        
        // 回车键登录
        document.getElementById('passwordInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        });
        
        // 默认的通讯录数据
        const defaultContactsData = `1,党政,金晶,,,13820868619
2,党政,尚用革,,,13312070700
3,党政,刘正文,,,15620565556
4,党政,林雷,,,18102116868
5,党政,马君静,,,13820025188
6,党政,赵元坤,,,13602041495
7,党政,张雯晶,,,15822730000
8,党政,徐福鹏,,,18622036918
9,党政,马燕丽,,,13672035881
10,党政,魏智超,,,13512477666
11,党政,刘艳,,,15620875826
12,党政,姚良田,,,15510997472
13,党政,张宝德,,,13752177538
14,党政,刘子鑫,,,18522720493
15,党政,张建亭,,,15510913720
16,党政,侯玉嵩,,,15854333267
17,党委办(人大办),孟铭辉,68120063,,18622699053
18,党委办(人大办),樊蓉,68120063,,17627684548
19,党委办(人大办),郑凯,68120063,,17866829580
20,党委办(人大办),王乔,68120063,,15602189093
21,党委办(人大办),王心怡,68120063,,13114951612
22,党委办(人大办),荣蓉,68120063,,17622571603
23,党委办(人大办),沙琳琳,68120063,,19922636889
24,党委办(人大办),刘晔,68120063,,15922000527
25,党委办(人大办),王克,,,13920473979
26,政府办,姚頔,68120168,,15620371493
27,政府办,邓波,68120168,,18920971591
28,政府办,陈宇清,68120168,,17726071230
29,政府办,黎志会,68120168,,13821821523
30,纪检室,王彬,68123106,,13662162166
31,纪检室,孔令振,68123106,,15522648761
32,工会妇联,郝海媚,68123109,,18810565483
33,工会妇联,贾硕,68123109,,15822312299
34,农业办,郭大星,68120068,,15522190533
35,农业办,于俊生,68120068,,13132273512
36,农业办,黄思萌,68120068,,13212056669
37,农业办,杨振强,68120068,,15922075300
38,农业办,商福丽,68120068,,18502266961
39,农业办,刘帅,68120068,,18698065373
40,农业办,孙策,68120068,,18920769595
41,农业办,李恩来,68120068,,13820820799
42,农业办,林广艳,68120068,,15302029861
43,农业办,孙昌平,68120068,,18222909243
44,农业办,张强,68120068,,13502088856
45,工业办,杜雨龙,68120071,,13820888863
46,工业办,郭俊玲,68120071,,13820058698
47,工业办,于洪春,68120071,,13702079811
48,工业办,杜效军,68120071,,13920016465
49,工业办,于顺尧,68120071,,15022744833
50,工业办,曹彤彤,68120071,,13512820088
51,工业办,杜恩禹,68120071,,17526536004
52,司法所,高永义,68120079,,15902288868
53,司法所,赵娟,68120079,,13672028571
54,司法所,刘琳,68120079,,18522506497
55,安监,赵磊,68123108,,18622852119
56,安监,张鹤馨,68123108,,18602630455
57,安监,刘阳,68123108,,18302275555
58,安监,张涛,68123108,,15510883180
59,安监,滑桂春,68123108,,18920591566
60,安监,杨健,68123108,,13022280995
61,卫健办,郝树云,68120369,,15002263296
62,卫健办,安秀英,68120369,,13132043877
63,卫健办,林永亮,68120084,,13821169309
64,卫健办,田静,68120084,,13323393635
65,卫健办,周作燕,68120084,,13516260311
66,卫健办,郝维,68120084,,13672157681
67,武装部,杨敬磊,,,15822211208
68,综治办信访办,翟炳浩,68128992,,18822620909
69,综治办信访办,葛学凯,68128992,,13302109995
70,综治办信访办,彭国政,68128992,病假,13682003180
71,综治办信访办,朱慧敏,68128992,,13526102969
72,综治办信访办,卢建旻,68128992,,15222788369
73,综治办信访办,宋友祥,68128992,,13132115305
74,乡文教,张英成,68120044,,13207688889
75,乡文教,于慧敏,68120044,,13920560996
76,统计办,郭巍琪,68123096,,15122407868
77,统计办,王钰,68123096,,15122055520
78,统计办,杜连霞,68123096,,13642169402
79,统计办,杜锁,68123096,,18526034253
80,城建办,刘生会,68123156,,13207653623
81,城建办,王蕊,68123156,,15733298634
82,城建办,杨帅,68123156,,15222225272
83,城建办,潘琦琦,68123156,,18722062480
84,环卫办（户厕办）,鲍志强,68121399,,13752738032
85,环卫办（户厕办）,张忠建,68121399,,13662052266
86,环卫办（户厕办）,韩素勇,68121399,,13502192191
87,环卫办（户厕办）,李津津,68121399,,13002249856
88,劳动保障,刘刚,68120333,,15620975178
89,劳动保障,陈彦君,68120333,,15022393432
90,劳动保障,赵胜,68120333,,18502255881
91,劳动保障,井萍,68120333,,18512240576
92,退役军人服务站,王煜颖,68132212,,15122944081
93,退役军人服务站,刘桐,68132212,,16600208000
94,服务大厅,张志发,68122915,,18920271365
95,财政所,朱建新,68120081,,13512226667
96,财政所,王雪妍,68120081,,15022336693
97,财政所,潘绍荣,68120081,,13102295093
98,财政所,耳贵瑞,68120081,,15922207913
99,民政办,胡艳华,68120078,,18602629788
100,民政办,赵丹,68120078,,13920339342
101,民政办,李欣,68120078,,15822322738
102,民政办,于珊,68120078,,15522312135
103,民政办,张闰智,68120078,,17301616592
104,村帐乡管,李德玲,68120456,,13920361122
105,村帐乡管,李润春,68120456,,18602631890
106,村帐乡管,李洪艳,68120456,,15620929970
107,河长办,张恩兴,,,18630896160
108,执法大队,朱军禾,68123098,,15822990028
109,执法大队,宋金胜,68123098,,15822990033
110,执法大队,项昆,68123098,,18630808606
111,执法大队,梁建忠,68123098,,15122547160
112,执法大队,刘雷,68123098,,18602680361
113,执法大队,杨恩祥,68123098,,13820504831
114,执法大队,杨鹏,68123098,,15900232223
115,执法大队,高明会,68123098,,15222025492
116,司机,张永路,,,13388019299
117,司机,梁金国,,,13821649187
118,门卫1,张文武,68122916,,13920907833
119,门卫1,闫福江,68122916,,15922075303
120,门卫2,杨恩祥,68122698,,13820504831
121,门卫2,郝连忠,68122698,68120989,13516108611
122,派出所,张雯晶,68120110,,15822730000
123,税务所,陈相,68815027,,13110063666
124,水站,刘伟,,,13110015200
125,市场监管所,董金锋,68123791,,13752568158
126,邮局,兰颖,68120405,,15692272230
127,卫生院,王宝良,68120042,,13212069756
128,农商行,闫隽,,,15802299095
129,电业所,张澜,68602096,,18920300189
130,电话站,张达,68120999,68120159,18602205375
131,电管站,马跃洲,,,13820048444`;

        let contacts = [];
        let departments = new Set();
        let editingContactId = null;
        let nextId = 132; // 下一个可用ID

        // 保存数据到本地存储
        function saveContactsToStorage() {
            try {
                const dataToSave = {
                    version: CURRENT_VERSION,
                    contacts: contacts,
                    nextId: nextId,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('数据已保存到本地存储');
            } catch (error) {
                console.error('保存数据失败:', error);
                alert('保存数据失败，请检查浏览器存储空间');
            }
        }

        // 从本地存储读取数据
        function loadContactsFromStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // 检查数据版本兼容性
                    if (parsedData.version === CURRENT_VERSION && parsedData.contacts) {
                        contacts = parsedData.contacts;
                        nextId = parsedData.nextId || getMaxId() + 1;
                        console.log(`已从本地存储加载 ${contacts.length} 条联系人数据`);
                        return true;
                    } else {
                        console.log('本地存储数据版本不匹配，使用默认数据');
                    }
                }
            } catch (error) {
                console.error('读取本地数据失败:', error);
            }
            
            // 如果没有本地数据或读取失败，使用默认数据
            parseContactsData();
            return false;
        }

        // 获取当前最大ID
        function getMaxId() {
            return contacts.length > 0 ? Math.max(...contacts.map(c => c.id)) : 0;
        }

        // 清除本地存储数据
        function clearLocalStorage() {
            if (confirm('确定要清除所有本地存储的数据吗？这将恢复到初始状态，所有修改都将丢失！')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(VERSION_KEY);
                
                // 重新加载默认数据
                parseContactsData();
                initializeDepartmentSelects();
                updateStats();
                displayContacts(contacts);
                
                showSuccessMessage('本地数据已清除，已恢复到初始状态');
            }
        }

        // 导出数据为JSON文件
        function exportData() {
            const dataToExport = {
                version: CURRENT_VERSION,
                contacts: contacts,
                exportTime: new Date().toISOString(),
                totalContacts: contacts.length
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `通讯录数据_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            showSuccessMessage('数据导出成功');
        }
        
        function initializeContacts() {
            // 首先尝试从本地存储加载数据
            const hasLocalData = loadContactsFromStorage();
            
            if (!hasLocalData) {
                console.log('使用默认数据');
            }
            
            // 重新构建部门列表
            departments.clear();
            contacts.forEach(contact => {
                departments.add(contact.department);
            });
            
            initializeDepartmentSelects();
            updateStats();
            displayContacts(contacts);
            
            // 显示数据来源提示
            if (hasLocalData) {
                showSuccessMessage('已加载本地保存的数据');
            }
        }

        function parseContactsData() {
            contacts = [];
            departments.clear();
            
            defaultContactsData.split('\n').forEach(line => {
                const parts = line.trim().split(',');
                if (parts.length >= 6) {
                    const contact = {
                        id: parseInt(parts[0]),
                        department: parts[1].trim(),
                        name: parts[2].trim(),
                        officePhone: parts[3].trim(),
                        homePhone: parts[4].trim(),
                        mobile: parts[5].trim()
                    };
                    contacts.push(contact);
                    departments.add(contact.department);
                    if (contact.id >= nextId) {
                        nextId = contact.id + 1;
                    }
                }
            });
        }

        function initializeDepartmentSelects() {
            // 初始化搜索部门下拉框
            const departmentFilter = document.getElementById('departmentFilter');
            departmentFilter.innerHTML = '<option value="">所有部门</option>';
            Array.from(departments).sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentFilter.appendChild(option);
            });

            // 初始化表单部门下拉框
            const contactDepartment = document.getElementById('contactDepartment');
            contactDepartment.innerHTML = '<option value="">请选择部门</option>';
            Array.from(departments).sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                contactDepartment.appendChild(option);
            });
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = contacts.length;
        }
        
        // 创建联系人卡片
        function createContactCard(contact) {
            const card = document.createElement('div');
            card.className = 'contact-card';
            
            let html = `
                <div class="contact-actions">
                    <button class="btn-edit" onclick="editContact(${contact.id})" title="编辑">✏️</button>
                    <button class="btn-delete" onclick="deleteContact(${contact.id})" title="删除">🗑️</button>
                </div>
                <div class="name">${contact.name}</div>
                <div class="department">${contact.department}</div>
            `;
            
            if (contact.mobile) {
                html += `<div class="info-item"><span class="icon">📱</span>${contact.mobile}</div>`;
            }
            
            if (contact.officePhone) {
                html += `<div class="info-item"><span class="icon">☎️</span>${contact.officePhone}</div>`;
            }
            
            if (contact.homePhone && contact.homePhone !== '病假') {
                html += `<div class="info-item"><span class="icon">🏠</span>${contact.homePhone}</div>`;
            }
            
            card.innerHTML = html;
            return card;
        }
        
        // 显示所有联系人
        function displayContacts(contactList) {
            const grid = document.getElementById('contactGrid');
            grid.innerHTML = '';
            
            if (contactList.length === 0) {
                grid.innerHTML = '<div class="no-results">没有找到符合条件的联系人</div>';
                return;
            }
            
            contactList.forEach(contact => {
                grid.appendChild(createContactCard(contact));
            });
            
            document.getElementById('filteredCount').textContent = contactList.length;
        }
        
        // 筛选联系人
        function filterContacts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedDept = document.getElementById('departmentFilter').value;
            
            const filtered = contacts.filter(contact => {
                const matchSearch = !searchTerm || 
                    contact.name.toLowerCase().includes(searchTerm) ||
                    contact.department.toLowerCase().includes(searchTerm) ||
                    (contact.mobile && contact.mobile.includes(searchTerm)) ||
                    (contact.officePhone && contact.officePhone.includes(searchTerm)) ||
                    (contact.homePhone && contact.homePhone.includes(searchTerm));
                
                const matchDept = !selectedDept || contact.department === selectedDept;
                
                return matchSearch && matchDept;
            });
            
            displayContacts(filtered);
        }

        // 显示新增联系人模态框
        function showAddModal() {
            editingContactId = null;
            document.getElementById('modalTitle').textContent = '新增联系人';
            document.getElementById('submitBtn').textContent = '保存';
            document.getElementById('contactForm').reset();
            document.getElementById('contactModal').style.display = 'block';
        }

        // 显示编辑联系人模态框
        function editContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;

            editingContactId = contactId;
            document.getElementById('modalTitle').textContent = '编辑联系人';
            document.getElementById('submitBtn').textContent = '更新';
            
            // 填充表单
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactDepartment').value = contact.department;
            document.getElementById('contactMobile').value = contact.mobile || '';
            document.getElementById('contactOfficePhone').value = contact.officePhone || '';
            document.getElementById('contactHomePhone').value = contact.homePhone || '';
            
            document.getElementById('contactModal').style.display = 'block';
        }

        // 删除联系人
        function deleteContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;

            if (confirm(`确定要删除联系人"${contact.name}"吗？此操作不可撤销。`)) {
                contacts = contacts.filter(c => c.id !== contactId);
                
                // 保存到本地存储
                saveContactsToStorage();
                
                departments.clear();
                contacts.forEach(c => departments.add(c.department));
                initializeDepartmentSelects();
                
                updateStats();
                filterContacts();
                
                showSuccessMessage(`联系人"${contact.name}"已成功删除并保存`);
            }
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('contactModal').style.display = 'none';
            document.getElementById('contactForm').reset();
            editingContactId = null;
        }

        // 显示成功消息
        function showSuccessMessage(message) {
            const msgElement = document.getElementById('successMessage');
            msgElement.textContent = message;
            msgElement.style.display = 'block';
            
            setTimeout(() => {
                msgElement.style.display = 'none';
            }, 3000);
        }

        // 显示数据管理模态框
        function showDataManagement() {
            document.getElementById('dataManageCount').textContent = contacts.length;
            
            // 获取最后更新时间
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    const updateTime = new Date(parsedData.timestamp).toLocaleString('zh-CN');
                    document.getElementById('lastUpdateTime').textContent = updateTime;
                } else {
                    document.getElementById('lastUpdateTime').textContent = '无本地数据';
                }
            } catch (error) {
                document.getElementById('lastUpdateTime').textContent = '获取失败';
            }
            
            document.getElementById('dataManagementModal').style.display = 'block';
        }

        // 关闭数据管理模态框
        function closeDataManagement() {
            document.getElementById('dataManagementModal').style.display = 'none';
        }

        // 处理表单提交
        document.getElementById('contactForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const contactData = {
                name: formData.get('name').trim(),
                department: formData.get('department'),
                mobile: formData.get('mobile').trim(),
                officePhone: formData.get('officePhone').trim(),
                homePhone: formData.get('homePhone').trim()
            };

            // 验证必填字段
            if (!contactData.name || !contactData.department) {
                alert('请填写姓名和部门！');
                return;
            }

            // 验证手机号格式
            if (contactData.mobile && !/^1[3-9]\d{9}$/.test(contactData.mobile)) {
                alert('请输入正确的手机号码！');
                return;
            }

            if (editingContactId) {
                // 更新现有联系人
                const contactIndex = contacts.findIndex(c => c.id === editingContactId);
                if (contactIndex !== -1) {
                    contacts[contactIndex] = {
                        ...contacts[contactIndex],
                        ...contactData
                    };
                    showSuccessMessage(`联系人"${contactData.name}"已成功更新并保存`);
                }
            } else {
                // 新增联系人
                const newContact = {
                    id: nextId++,
                    ...contactData
                };
                contacts.push(newContact);
                showSuccessMessage(`联系人"${contactData.name}"已成功添加并保存`);
            }

            // 保存到本地存储
            saveContactsToStorage();
            
            // 更新数据
            departments.add(contactData.department);
            initializeDepartmentSelects();
            updateStats();
            filterContacts();
            closeModal();
        });

        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            const contactModal = document.getElementById('contactModal');
            const dataModal = document.getElementById('dataManagementModal');
            if (event.target === contactModal) {
                closeModal();
            } else if (event.target === dataModal) {
                closeDataManagement();
            }
        });

        // ESC键关闭模态框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeDataManagement();
            }
        });
    </script>
</body>
</html>
